\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{main}

% Markup
\def\scamp{{\footnotesize\&}}                      % A fake small-caps ampersand
\def\footnote#1{\marginpar{\small\raggedright#1}}  % Margin footnotes
\def\filename#1{ (\texttt{#1})}                    % Filenames in captions
\let\work\textit                                   % Names of written works
\let\term\textit                                   % First occurances of terms
\def\inx#1{#1\index{#1}}                           % Leaky indexing
\def\element#1{\mintinline{html}{<#1>}}            % An SGML or XML element
\let\identifier\texttt                    % A general ASCII identifier
\def\Identifier#1{{%                      % ... at the beginning of a sentence
  \def\head##1##2\relax{##1}
  \def\tail##1##2\relax{##2}
  \identifier{\uppercase{\head#1\relax}\tail#1\relax}}}
%% Faking chapters and TOC entries
\def\faketoc#1{%                          % A forced TOC entry
  \addcontentsline{toc}{chapter}{#1}}
\usepackage{afterpage}
\def\fakechapter#1{%                      % An unnumbered chapter head
  \chapter*{#1}
  \markright{\MakeUppercase{#1}}
  \afterpage{\markboth{\MakeUppercase{#1}}{\MakeUppercase{#1}}}
  \faketoc{#1}}
%% Acronyms
\usepackage{acro}
\newcommand{\defacronym}[3][]{%           % An acronym definition
  \mdefacronym[#1]{#2}{#2}{#3}}  
\newcommand{\mdefacronym}[4][]{%          % A manual acronym definition 
  \DeclareAcronym{#2}{%                   %   #1: options, #2: handle
    short={\MakeLowercase{#3}},%          %   #3: short form, #4: long form
    long={#4},
    long-plural-form={#4s},#1}}
\def\acronym#1{\ac{#1}\acroindex{#1}}     % An acronym
\def\Acronym#1{\Ac{#1}\acroindex{#1}}     % ... at the beginning of a sentence
\def\acropl#1{\acp{#1}\acroindex{#1}}     % ... in the plural form 
\def\acroshort#1{\acs{#1}\acroindex{#1}}  % ... in the unexpanded form
\def\acrolong#1{\acl{#1}\acroindex{#1}}   % ... in the expanded form
\newcommand{\acroindex}[2][]{\expandafter\index\expandafter%
  {#2@\acs*{#2}#1}}
\def\acroflat#1{\textsc{\MakeLowercase{#1}}} % An acronym w/o prior definition

% Design
%% No em-spaces after full stops
\frenchspacing
%% No clubs and widows
\usepackage[all]{nowidow}
%% Fonts
\usepackage{fontspec}
\usepackage{unicode-math}
\setmainfont[Numbers=OldStyle,Ligatures=TeX]{TeX Gyre Pagella}
\setmonofont[Ligatures=TeX,Scale=MatchLowercase]{Inconsolata}
\setmathfont[math-style=ISO,bold-style=ISO,vargreek-shape=TeX]%
  {texgyrepagella-math.otf}
%% Protrusion
\usepackage[protrusion]{microtype}
%% Acronyms
\acsetup{
  first-long-format=\itshape,
  short-format=\scshape,
  list-short-format=\scshape,
  list-caps=true,
  index-cmd=\acroindex}
%% Line numbers
%% @see <http://tex.stackexchange.com/a/132850/70941>
\renewcommand{\theFancyVerbLine}{{\rm\normalsize{\arabic{FancyVerbLine}}}}
